<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é€‚è€åŒ–é£Ÿç–—å¹³å° - ç®¡ç†å‘˜ç‰ˆ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
      color: #333;
    }

    header {
      background-color: #4caf50;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    main {
      max-width: 800px;
      margin: auto;
      padding: 1rem;
    }

    .card {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
      position: relative;
    }

    .card img {
      max-width: 100%;
      border-radius: 1rem;
    }

    .large-font {
      font-size: 1.5em;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    input,
    textarea {
      width: 100%;
      padding: 0.5rem;
      font-size: 1em;
      box-sizing: border-box;
    }

    button {
      padding: 0.5rem 1rem;
      font-size: 1em;
      border: none;
      border-radius: 0.5rem;
      background-color: #4caf50;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      background-color: #9e9e9e;
      cursor: not-allowed;
    }

    /* ç®¡ç†å‘˜ç¼–è¾‘åˆ é™¤æŒ‰é’®æ ·å¼ */
    .edit-btn,
    .delete-btn {
      position: absolute;
      top: 10px;
      padding: 5px 10px;
      font-size: 0.9em;
      border-radius: 0.5rem;
      cursor: pointer;
      color: white;
    }

    .edit-btn {
      right: 70px;
      background-color: #2196f3;
    }

    .delete-btn {
      right: 10px;
      background-color: #f44336;
    }

    #authSection,
    #registerSection {
      background-color: #e8f5e9;
      padding: 1rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* éšè—æ‘„åƒå¤´video */
    #cameraFeed {
      display: none;
    }
  </style>

  <!-- æ–°å¢ï¼šå¼•å…¥face-api.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
</head>

<body>
  <header>
    <h1 id="title">çº¿ä¸Šé£Ÿç–—é£Ÿæå¹³å°</h1>
    <div style="display:flex; justify-content:center; gap: 1rem; flex-wrap: wrap;">
      <button onclick="toggleFont()">ğŸ§“ åˆ‡æ¢å¤§å­—ä½“</button>
      <button onclick="toggleLanguage()">ğŸ”Š æ’­æŠ¥ï¼š<span id="langLabel">æ™®é€šè¯</span></button>
      <span id="userInfo" style="line-height:2rem;"></span>
      <button id="logoutBtn" style="display:none;" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <!-- æ–°å¢ï¼šæ‘„åƒå¤´video -->
  <video id="cameraFeed" width="320" height="240" autoplay muted></video>

  <main>
    <!-- ç™»å½•åŒºåŸŸ -->
    <section id="authSection">
      <h2>ğŸ‘¤ ç”¨æˆ·ç™»å½•</h2>
      <input id="username" placeholder="ç”¨æˆ·å" autocomplete="username" />
      <input id="password" type="password" placeholder="å¯†ç " autocomplete="current-password" />
      <div style="margin-top: 0.5rem; display:flex; gap:0.5rem; flex-wrap: wrap; justify-content:center;">
        <button id="loginBtn">ç™»å½•</button>
        <button id="showRegisterBtn">æ³¨å†Œ</button>
      </div>
      <p id="authStatus" style="color:red; text-align:center;"></p>
    </section>

    <!-- æ³¨å†ŒåŒºåŸŸ -->
    <section id="registerSection" style="display:none;">
      <h2>ğŸ“ ç”¨æˆ·æ³¨å†Œ</h2>
      <input id="regUsername" placeholder="ç”¨æˆ·å" autocomplete="username" />
      <input id="regPassword" type="password" placeholder="å¯†ç " autocomplete="new-password" />
      <div style="margin-top: 0.5rem; display:flex; gap:0.5rem; flex-wrap: wrap; justify-content:center;">
        <button id="registerBtn">æ³¨å†Œ</button>
        <button id="showLoginBtn">è¿”å›ç™»å½•</button>
      </div>
      <p id="registerStatus" style="color:red; text-align:center;"></p>
    </section>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <section id="mainSection" style="display:none;">
      <!-- ç®¡ç†å‘˜ä¸“å±æ·»åŠ å†…å®¹åŒºåŸŸ -->
      <div id="adminControls" class="controls" style="display:none;">
        <input type="file" accept="image/*" onchange="handleUpload(event)" />
        <input id="titleInput" placeholder="è¾“å…¥æ ‡é¢˜..." />
        <textarea id="descInput" placeholder="è¾“å…¥æè¿°..."></textarea>
        <input id="linkInput" placeholder="è¾“å…¥äº§å“è´­ä¹°é“¾æ¥..." />
        <button id="addCardBtn">æ·»åŠ é£Ÿæå¡ç‰‡</button>
      </div>
      <div id="cardContainer"></div>
    </section>
  </main>

  <script>
    // ç®¡ç†å‘˜è´¦å·æ”¹ä¸º swhï¼Œå¯†ç æ”¹ä¸º 123456swh
    const ADMIN_USERNAME = 'swh';

    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const defaultGlobalCards = [
      {
        image: 'https://cdn.pixabay.com/photo/2017/01/20/00/30/mushrooms-1996417_960_720.jpg',
        title: 'é¦™è‡',
        desc: 'å¢å¼ºå…ç–«åŠ›ï¼Œè¡¥æ°”å…»è¡€ã€‚',
        link: 'https://example.com/product/xianggu'
      },
      {
        image: 'https://cdn.pixabay.com/photo/2016/03/05/19/02/ginger-1238243_960_720.jpg',
        title: 'ç”Ÿå§œ',
        desc: 'é©±å¯’æš–èƒƒï¼Œä¿ƒè¿›æ¶ˆåŒ–ã€‚',
        link: 'https://example.com/product/shengjiang'
      }
    ];

    let lang = 'zh';
    const synth = window.speechSynthesis;
    let latestImageData = null;

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('showRegisterBtn').addEventListener('click', showRegister);
      document.getElementById('showLoginBtn').addEventListener('click', showLogin);
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('registerBtn').addEventListener('click', register);
      document.getElementById('addCardBtn').addEventListener('click', addCard);

      initAdminAccount();

      if (localStorage.getItem('loggedInUser')) {
        showMainInterface();
        loadGlobalCards();
      } else {
        showLogin();
      }

      // æ–°å¢ï¼šå¯åŠ¨äººè„¸è·ç¦»æ£€æµ‹
      startFaceDetectionMinimal();
    });

    async function initAdminAccount() {
      if (!localStorage.getItem('user_' + ADMIN_USERNAME)) {
        // ç®¡ç†å‘˜å¯†ç æ”¹ä¸º 123456swh
        const passHash = await sha256('123456swh');
        const adminData = {
          passwordHash: passHash
        };
        localStorage.setItem('user_' + ADMIN_USERNAME, JSON.stringify(adminData));
      }
    }

    function showRegister() {
      clearMessages();
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('registerSection').style.display = 'block';
      document.getElementById('mainSection').style.display = 'none';
    }

    function showLogin() {
      clearMessages();
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('registerSection').style.display = 'none';
      document.getElementById('mainSection').style.display = 'none';
    }

    function showMainInterface() {
      clearMessages();
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('registerSection').style.display = 'none';
      document.getElementById('mainSection').style.display = 'block';

      const user = localStorage.getItem('loggedInUser');
      const userInfo = document.getElementById('userInfo');
      userInfo.style.display = 'inline-block';
      userInfo.textContent = `æ‚¨å¥½ï¼Œ${user} ${isAdmin(user) ? '(ç®¡ç†å‘˜)' : ''}`;
      document.getElementById('logoutBtn').style.display = 'inline-block';

      document.getElementById('adminControls').style.display = isAdmin(user) ? 'flex' : 'none';
      document.getElementById('addCardBtn').disabled = !isAdmin(user);
    }

    function clearMessages() {
      document.getElementById('authStatus').textContent = '';
      document.getElementById('registerStatus').textContent = '';
    }

    async function register() {
      clearMessages();
      const user = document.getElementById('regUsername').value.trim();
      const pass = document.getElementById('regPassword').value.trim();
      const status = document.getElementById('registerStatus');

      if (!user || !pass) {
        status.textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º';
        return;
      }
      if (user === ADMIN_USERNAME) {
        status.textContent = 'æ­¤ç”¨æˆ·åä¸ºä¿ç•™ç®¡ç†å‘˜è´¦å·ï¼Œä¸èƒ½æ³¨å†Œ';
        return;
      }
      if (localStorage.getItem('user_' + user)) {
        status.textContent = 'è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œ';
        return;
      }

      const hash = await sha256(pass);
      const userData = {
        passwordHash: hash
      };
      localStorage.setItem('user_' + user, JSON.stringify(userData));

      status.style.color = 'green';
      status.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•';
      setTimeout(() => {
        showLogin();
        document.getElementById('username').value = user;
        document.getElementById('password').value = '';
        status.style.color = 'red';
        status.textContent = '';
      }, 1500);
    }

    async function login() {
      clearMessages();
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      const status = document.getElementById('authStatus');

      if (!user || !pass) {
        status.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        return;
      }

      const userDataStr = localStorage.getItem('user_' + user);
      if (!userDataStr) {
        status.style.color = 'red';
        status.textContent = 'âŒ è´¦å·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ';
        return;
      }

      const userData = JSON.parse(userDataStr);
      const hash = await sha256(pass);
      if (hash !== userData.passwordHash) {
        status.style.color = 'red';
        status.textContent = 'âŒ å¯†ç é”™è¯¯';
        return;
      }

      localStorage.setItem('loggedInUser', user);
      showMainInterface();
      loadGlobalCards();
    }

    function logout() {
      localStorage.removeItem('loggedInUser');
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('cardContainer').innerHTML = '';
      document.getElementById('mainSection').style.display = 'none';
      showLogin();
    }

    function isAdmin(user) {
      return user === ADMIN_USERNAME;
    }

    function speak(text) {
      if (!text) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang === 'zh' ? 'zh-CN' : 'yue-HK';
      synth.speak(utter);
    }

    function toggleFont() {
      document.body.classList.toggle('large-font');
    }

    function toggleLanguage() {
      lang = lang === 'zh' ? 'yue' : 'zh';
      document.getElementById('langLabel').innerText = lang === 'zh' ? 'æ™®é€šè¯' : 'ç²¤è¯­';
    }

    function handleUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        latestImageData = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function addCard() {
      const user = localStorage.getItem('loggedInUser');
      if (!user || !isAdmin(user)) {
        alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ å†…å®¹');
        return;
      }
      if (!latestImageData) {
        alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
        return;
      }

      const title = document.getElementById('titleInput').value.trim();
      const desc = document.getElementById('descInput').value.trim();
      const link = document.getElementById('linkInput').value.trim();

      if (!title) {
        alert('è¯·è¾“å…¥æ ‡é¢˜');
        return;
      }
      if (!desc) {
        alert('è¯·è¾“å…¥æè¿°');
        return;
      }

      const cards = getGlobalCards();
      cards.push({
        image: latestImageData,
        title,
        desc,
        link
      });
      saveGlobalCards(cards);
      renderCards(cards);

      document.getElementById('titleInput').value = '';
      document.getElementById('descInput').value = '';
      document.getElementById('linkInput').value = '';
      latestImageData = null;
      document.querySelector('input[type="file"]').value = '';
    }

    function getGlobalCards() {
      const data = localStorage.getItem('globalCards');
      if (!data) return [...defaultGlobalCards];
      try {
        const arr = JSON.parse(data);
        if (Array.isArray(arr)) return arr;
        else return [...defaultGlobalCards];
      } catch {
        return [...defaultGlobalCards];
      }
    }

    function saveGlobalCards(cards) {
      localStorage.setItem('globalCards', JSON.stringify(cards));
    }

    function renderCards(cards) {
      const container = document.getElementById('cardContainer');
      container.innerHTML = '';
      cards.forEach((card, idx) => {
        const { image, title, desc, link } = card;

        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';

        const img = document.createElement('img');
        img.src = image;
        img.alt = 'é£Ÿæå›¾ç‰‡';

        const h3 = document.createElement('h3');
        h3.textContent = title;

        const p = document.createElement('p');
        p.textContent = desc;

        const speakBtn = document.createElement('button');
        speakBtn.textContent = 'ğŸ”Š æ’­æŠ¥æ–‡å­—';
        speakBtn.onclick = () => speak(title + 'ï¼Œ' + desc);

        cardDiv.appendChild(img);
        cardDiv.appendChild(h3);
        cardDiv.appendChild(p);
        cardDiv.appendChild(speakBtn);

        if (isAdmin(localStorage.getItem('loggedInUser'))) {
          const editBtn = document.createElement('button');
          editBtn.className = 'edit-btn';
          editBtn.textContent = 'ç¼–è¾‘';
          editBtn.onclick = () => editCard(idx);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'åˆ é™¤';
          deleteBtn.onclick = () => deleteCard(idx);

          cardDiv.appendChild(editBtn);
          cardDiv.appendChild(deleteBtn);
        } else {
          speakBtn.disabled = false;
        }

        container.appendChild(cardDiv);
      });
    }

    function loadGlobalCards() {
      const cards = getGlobalCards();
      renderCards(cards);
    }

    function editCard(index) {
      const cards = getGlobalCards();
      const card = cards[index];
      if (!card) return alert('å¡ç‰‡ä¸å­˜åœ¨');

      const newTitle = prompt('ä¿®æ”¹æ ‡é¢˜', card.title);
      if (newTitle === null) return;
      const newDesc = prompt('ä¿®æ”¹æè¿°', card.desc);
      if (newDesc === null) return;
      const newLink = prompt('ä¿®æ”¹è´­ä¹°é“¾æ¥', card.link || '');
      if (newLink === null) return;

      cards[index] = {
        ...card,
        title: newTitle.trim() || card.title,
        desc: newDesc.trim() || card.desc,
        link: newLink.trim()
      };
      saveGlobalCards(cards);
      renderCards(cards);
    }

    function deleteCard(index) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥é£Ÿæå¡ç‰‡å—ï¼Ÿ')) return;
      const cards = getGlobalCards();
      cards.splice(index, 1);
      saveGlobalCards(cards);
      renderCards(cards);
    }


    // æ–°å¢éƒ¨åˆ†ï¼šæ‘„åƒå¤´äººè„¸è·ç¦»æ£€æµ‹
    let hasPromptedFontSize = false;

    async function startFaceDetectionMinimal() {
      const video = document.getElementById('cameraFeed');

      try {
        // åŠ è½½ tinyFaceDetector æ¨¡å‹
        await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models');

        // å¯åŠ¨æ‘„åƒå¤´
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        video.addEventListener('play', () => {
          const intervalId = setInterval(async () => {
            if (hasPromptedFontSize) {
              clearInterval(intervalId); // å·²æç¤ºè¿‡ï¼Œåœæ­¢æ£€æµ‹
              return;
            }
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            if (detections.length > 0) {
              const box = detections[0].box;
              const faceArea = box.width * box.height;

              // é˜ˆå€¼ï¼šæ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´ï¼ˆæ­¤å€¼è¡¨ç¤ºè„¸å¤§äºå¤šå°‘åƒç´ é¢ç§¯å°±æç¤ºï¼‰
              if (faceArea > 15000) {
                hasPromptedFontSize = true;
                const userConfirm = confirm("æ£€æµ‹åˆ°æ‚¨è·ç¦»å±å¹•è¾ƒè¿‘ï¼Œæ˜¯å¦åˆ‡æ¢å¤§å­—ä½“æ¨¡å¼ï¼Ÿ");
                if (userConfirm) {
                  toggleFont();
                }
              }
            }
          }, 2000); // 2ç§’æ£€æµ‹ä¸€æ¬¡
        });
      } catch (err) {
        console.warn("æ‘„åƒå¤´è°ƒç”¨å¤±è´¥æˆ–æ— æƒé™ï¼š", err);
      }
    }
  </script>
</body>

</html>
